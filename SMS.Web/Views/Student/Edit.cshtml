@model SMS.Web.Models.StudentUpdateViewModel
@{
    ViewData["Title"] = "Edit Student";
}

<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-primary text-white py-3">
                <h4 class="mb-0"><i class="bi bi-pencil-square me-2"></i>Edit Student: @Model.StudentId</h4>
            </div>
            <div class="card-body p-4">
                <form asp-action="Edit" method="post" id="editForm">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
                    <input type="hidden" asp-for="Id" />
                    <input type="hidden" asp-for="StudentId" />
                    <input type="hidden" asp-for="Username" />
                    <input type="hidden" asp-for="Email" />

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="FirstName" class="form-label font-weight-bold"></label>
                            <input asp-for="FirstName" class="form-control" placeholder="John" />
                            <span asp-validation-for="FirstName" class="text-danger"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="LastName" class="form-label font-weight-bold"></label>
                            <input asp-for="LastName" class="form-control" placeholder="Doe" />
                            <span asp-validation-for="LastName" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label asp-for="Age" class="form-label font-weight-bold"></label>
                            <input asp-for="Age" type="number" class="form-control" id="ageInput" readonly />
                            <span asp-validation-for="Age" class="text-danger"></span>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label asp-for="DOB" class="form-label font-weight-bold"></label>
                            <input asp-for="DOB" type="date" class="form-control" id="dobInput" />
                            <span asp-validation-for="DOB" class="text-danger"></span>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label asp-for="Gender" class="form-label font-weight-bold"></label>
                            <select asp-for="Gender" class="form-select">
                                <option value="">-- Select Gender --</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                            <span asp-validation-for="Gender" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="Email" class="form-label font-weight-bold"></label>
                            <input asp-for="Email" class="form-control" disabled />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="PhoneNumber" class="form-label font-weight-bold"></label>
                            <input asp-for="PhoneNumber" class="form-control" placeholder="9876543210" />
                            <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                        </div>
                    </div>

                    <hr />
                    <h5 class="mb-3">Qualification Details</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered" id="qualificationTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Course</th>
                                    <th>University</th>
                                    <th>Year</th>
                                    <th>Percentage</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (int i = 0; i < Model.Qualifications.Count; i++)
                                {
                                    <tr>
                                        <td>
                                            <input name="Qualifications[@i].CourseName" class="form-control" value="@Model.Qualifications[i].CourseName" required />
                                        </td>
                                        <td>
                                            <input name="Qualifications[@i].University" class="form-control" value="@Model.Qualifications[i].University" required />
                                        </td>
                                        <td>
                                            <input name="Qualifications[@i].YearOfPassing" type="number" class="form-control" value="@Model.Qualifications[i].YearOfPassing" required />
                                        </td>
                                        <td>
                                            <input name="Qualifications[@i].Percentage" type="number" step="0.01" class="form-control" value="@Model.Qualifications[i].Percentage" required />
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-danger remove-row">Remove</button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="4"></td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-success w-100" id="addingQual">Add</button>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div class="mt-4 text-end">
                        <a asp-action="Index" class="btn btn-secondary me-2">Cancel</a>
                        <button type="submit" class="btn btn-primary px-4">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(document).ready(function () {
            // Auto-calculate Age from DOB
            function calculateAge(dob) {
                if (!dob) return "";
                const birthDate = new Date(dob);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const m = today.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                return age;
            }

            $("#dobInput").on("change", function () {
                const age = calculateAge($(this).val());
                $("#ageInput").val(age);
            });

            // Initial calculation
            if($("#dobInput").val()) {
                $("#ageInput").val(calculateAge($("#dobInput").val()));
            }

            let rowIdx = @Model.Qualifications.Count;

            // Add dynamic row
            $("#addingQual").click(function () {
                var newRow = `<tr>
                    <td><input name="Qualifications[${rowIdx}].CourseName" class="form-control" required /></td>
                    <td><input name="Qualifications[${rowIdx}].University" class="form-control" required /></td>
                    <td><input name="Qualifications[${rowIdx}].YearOfPassing" type="number" class="form-control" required /></td>
                    <td><input name="Qualifications[${rowIdx}].Percentage" type="number" step="0.01" class="form-control" required /></td>
                    <td><button type="button" class="btn btn-sm btn-danger remove-row">Remove</button></td>
                </tr>`;
                $("#qualificationTable tbody").append(newRow);
                rowIdx++;
            });

            // Remove dynamic row
            $("#qualificationTable").on("click", ".remove-row", function () {
                $(this).closest("tr").remove();
                reindexRows();
            });

            function reindexRows() {
                $("#qualificationTable tbody tr").each(function (index) {
                    $(this).find("input").each(function () {
                        var name = $(this).attr("name");
                        if (name) {
                            var newName = name.replace(/\[\d+\]/, "[" + index + "]");
                            $(this).attr("name", newName);
                        }
                    });
                });
                rowIdx = $("#qualificationTable tbody tr").length;
            }
        });
    </script>
}
