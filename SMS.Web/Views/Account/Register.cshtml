@model SMS.Web.Models.StudentRegistrationViewModel
@{
    ViewData["Title"] = "Student Registration";
}

<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Student Registration Form</h4>
        </div>
        <div class="card-body">
            <form asp-action="Register" id="registrationForm">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="FirstName" class="form-label font-weight-bold"></label>
                        <input asp-for="FirstName" class="form-control" placeholder="Enter First Name" />
                        <span asp-validation-for="FirstName" class="text-danger"></span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label asp-for="LastName" class="form-label font-weight-bold"></label>
                        <input asp-for="LastName" class="form-control" placeholder="Enter Last Name" />
                        <span asp-validation-for="LastName" class="text-danger"></span>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label asp-for="Age" class="form-label font-weight-bold"></label>
                        <input asp-for="Age" type="number" class="form-control" id="ageInput" readonly />
                        <span asp-validation-for="Age" class="text-danger"></span>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label asp-for="DOB" class="form-label font-weight-bold"></label>
                        <input asp-for="DOB" type="date" class="form-control" id="dobInput" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
                        <span asp-validation-for="DOB" class="text-danger"></span>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label asp-for="Gender" class="form-label font-weight-bold"></label>
                        <select asp-for="Gender" class="form-select">
                            <option value="">-- Select Gender --</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                        <span asp-validation-for="Gender" class="text-danger"></span>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="Email" class="form-label font-weight-bold"></label>
                        <input asp-for="Email" class="form-control" placeholder="example@domain.com" />
                        <span asp-validation-for="Email" class="text-danger"></span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label asp-for="PhoneNumber" class="form-label font-weight-bold"></label>
                        <input asp-for="PhoneNumber" class="form-control" placeholder="9876543210" />
                        <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="Username" class="form-label font-weight-bold"></label>
                        <input asp-for="Username" class="form-control" />
                        <span asp-validation-for="Username" class="text-danger"></span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label asp-for="Password" class="form-label font-weight-bold"></label>
                        <div class="input-group">
                            <input asp-for="Password" type="password" class="form-control" id="passwordInput" />
                            <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                <i class="bi bi-eye" id="eyeIcon"></i>
                            </button>
                        </div>
                        <span asp-validation-for="Password" class="text-danger"></span>
                    </div>
                </div>

                <hr />
                <h5 class="mb-3">Qualification Details</h5>
                <div class="table-responsive">
                    <table class="table table-bordered" id="qualificationTable">
                        <thead class="table-light">
                            <tr>
                                <th>Course</th>
                                <th>University</th>
                                <th>Year</th>
                                <th>Percentage</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dynamic rows will be added here -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4"></td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-success w-100" id="addingQual">Add</button>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="mt-4 text-end">
                    <a asp-controller="Account" asp-action="Login" class="btn btn-secondary me-2">Back to Login</a>
                    <button type="submit" class="btn btn-primary px-4">Register</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(document).ready(function () {
            // Password Visibility Toggle
            $("#togglePassword").click(function () {
                const passwordField = $("#passwordInput");
                const eyeIcon = $("#eyeIcon");
                const type = passwordField.attr("type") === "password" ? "text" : "password";
                passwordField.attr("type", type);
                
                if (type === "text") {
                    eyeIcon.removeClass("bi-eye").addClass("bi-eye-slash");
                } else {
                    eyeIcon.removeClass("bi-eye-slash").addClass("bi-eye");
                }
            });

            // Auto-calculate Age from DOB
            function calculateAge(dob) {
                if (!dob) return "";
                const birthDate = new Date(dob);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const m = today.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                return age;
            }

            $("#dobInput").on("change", function () {
                const age = calculateAge($(this).val());
                $("#ageInput").val(age);
            });

            // Initial calculation if value exists
            if($("#dobInput").val()) {
                $("#ageInput").val(calculateAge($("#dobInput").val()));
            }

            let rowIdx = 0;

            // Add dynamic row
            $("#addingQual").click(function () {
                const newRow = `
                    <tr id="row_${rowIdx}">
                        <td>
                            <input name="Qualifications[${rowIdx}].CourseName" class="form-control q-course" required />
                            <span class="text-danger validation-msg"></span>
                        </td>
                        <td>
                            <input name="Qualifications[${rowIdx}].University" class="form-control q-university" required />
                            <span class="text-danger validation-msg"></span>
                        </td>
                        <td>
                            <input name="Qualifications[${rowIdx}].YearOfPassing" type="number" class="form-control q-year" required min="1900" max="2100" />
                            <span class="text-danger validation-msg"></span>
                        </td>
                        <td>
                            <input name="Qualifications[${rowIdx}].Percentage" type="number" step="0.01" class="form-control q-percent" required min="0" max="100" />
                            <span class="text-danger validation-msg"></span>
                        </td>
                        <td class="text-center">
                            <button type="button" class="btn btn-danger btn-sm removeQual">Remove</button>
                        </td>
                    </tr>
                `;
                $("#qualificationTable tbody").append(newRow);
                rowIdx++;
                reIndexRows();
            });

            // Remove row
            $(document).on("click", ".removeQual", function () {
                $(this).closest("tr").remove();
                reIndexRows();
            });

            function reIndexRows() {
                $("#qualificationTable tbody tr").each(function (index) {
                    $(this).attr("id", "row_" + index);
                    $(this).find(".q-course").attr("name", `Qualifications[${index}].CourseName`);
                    $(this).find(".q-university").attr("name", `Qualifications[${index}].University`);
                    $(this).find(".q-year").attr("name", `Qualifications[${index}].YearOfPassing`);
                    $(this).find(".q-percent").attr("name", `Qualifications[${index}].Percentage`);
                });
                rowIdx = $("#qualificationTable tbody tr").length;
            }

            // Custom JQuery Validation for dynamic table
            $("#registrationForm").on("submit", function(e) {
                let isValid = true;
                
                // Trigger default validation
                if(!$(this).valid()) {
                    isValid = false;
                }

                // Check if at least one qualification is added
                if ($("#qualificationTable tbody tr").length === 0) {
                    alert("Please add at least one qualification.");
                    isValid = false;
                }

                if(!isValid) {
                    e.preventDefault();
                }
            });
        });
    </script>
}
